---
title: "China's Foreign Direct Investment (FDI)"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: cosmo
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(tibble)
library(ggplot2)
library(readr)
library(plotly)
library(DT)
library(RColorBrewer)
if(!require(geojsonio)) install.packages("geojsonio", repos = "http://cran.us.r-project.org")
if(!require(leaflet)) install.packages("leaflet", repos = "http://cran.us.r-project.org")
if(!require(RColorBrewer)) install.packages("RColorBrewer", repos = "http://cran.us.r-project.org")

library(geojsonio)
library(leaflet)
library(RColorBrewer)

outflows_filepath <- file.path(getwd(), "data", "Outflows.csv")
df <- read_csv(outflows_filepath)

chinainv_clean_fp <- file.path(getwd(), "data", "chinainv_clean.csv")
chinainv_clean <- read.csv(chinainv_clean_fp)
```

Overview
===================================== 
### Age of Competition?
Tensions between China and the United States continue to make headlines on a frequent basis, and we can continue to expect this mounting tension to continue. On the economic front, the ongoing [US-China Trade War](https://thediplomat.com/2021/03/the-us-china-trade-war-is-still-happening/) is an oft cited consequence of this tension. Through this dashboard, we hope to shed light into another economic frontier of China's continued growth -- their foreign investments to other countries, around the world. 

China's success in establishing itself as a global superpower is contingent on the volume of its foreign direct investment. Beyond being one way that China might continue to gain influence, foreign investments are one key way for China to [garner more strategic resources, which will increase its economic competitiveness](https://thediplomat.com/2020/01/the-investment-war-with-china-assessing-american-pressure/). This causes tension with the United States.

Claims on the volume of foreign investments by China, are best mapped out with data.

In this dashboard, we visualize  **China's growth in outward-oriented foreign investments**. We do this at the level of the entire world, and also at the level of a single continent, Africa, where Chinese Investments have been [on the rise over the years](https://www.forbes.com/sites/earlcarr/2020/09/04/the-us-versus-chinese-investment-in-africa/?sh=2efe223965d4); it is one key part of the world where experts expect [US-China competition to intensify](https://www.cnbc.com/2019/10/09/the-us-china-trade-rivalry-is-underway-in-africa.html).

We hope that by doing so, we are able to map out the contours of Chinese investment activity, which will be useful for observers of China and of US-China relations. 

Please explore each tabs to find out more: 

1. World Map - Where is China investing in? 

2. Yearly Investments by Categories - What is China investing in? 

3. Rising Outflows - Is China really investing more than the US? 

4. Next Frontier: Africa - What do we know about how China and the US are investing in Africa?

World Map
===================================== 
### Commentary

Where is China investing in? 

This segment displays a world map of the location of China's investments over the years, overall, and by industry, from 2005 to 2020. 

As visible from the coloration on the map (i.e., darker colors refer to a greater value of investment in a country), China is involved in investments across the entire world. It appears to have invested most heavily in the USA, the UK, Indonesia and Australia by raw total amount (in US dollars), but it also has a growing amount of investments in Russia as well as other countries in Europe, Africa, the Americas, Central Asia and Southeast Asia. 

Please explore different industries, hover over each country for more information on the name of the country, and the amount that China has invested in the country (in USD).

As this is quite an information-rich visualization, a Data Table is appended below for further exploration.

### China's Investment Around the World (in USD)

```{r Preparing dataset, include=FALSE}
# Preparing dataset
df_china_invest = read.csv('./data/china_investments.csv')
countries = read.csv("./data/countries_codes_and_coordinates.csv")
worldcountry = geojson_read("./data/50m.geojson", what = "sp")
```
```{r, include=FALSE}
# check consistency of country names across datasets
df_china_invest = df_china_invest %>%
  filter(Country != 'South Sudan') %>% 
  mutate(Country = gsub("Britain", "UK", Country)) %>%
  mutate(Country = gsub("Laos", "Lao People's Democratic Republic", Country)) %>%
  mutate(Country = gsub("Iran", "Iran (Islamic Republic of)", Country)) %>%
  mutate(Country = gsub("UAE", "United Arab Emirates", Country)) %>%
  mutate(Country = gsub("\\<Congo\\>", "Democratic Republic of the Congo", Country)) %>% 
  mutate(Country = gsub("Tanzania", "Tanzania, United Republic of", Country)) %>%
  mutate(Country = gsub("Trinidad-Tobago", "Trinidad & Tobago", Country)) %>%
  mutate(Country = gsub("Bahamas", "The Bahamas", Country)) %>%
  mutate(Country = gsub("South Korea", "Republic of Korea", Country)) %>%
  mutate(Country = gsub("Bosnia", "Bosnia and Herzegovina", Country)) %>%
  mutate(Country = gsub("North Korea", "Korea, Democratic People's Republic of", Country)) %>%
  mutate(Country = gsub("Sao Tome", "Sao Tome and Principe", Country)) %>%
  mutate(Country = gsub("Macedonia", "North Macedonia", Country)) %>%
  mutate(Country = gsub("Moldova", "Moldova, Republic of", Country))

if (all(unique(df_china_invest$Country) %in% unique(countries$country))==FALSE) { print("Error: inconsistent country names")}

df_china_invest = merge(df_china_invest, countries, by.x = "Country", by.y = "country")
df_china_invest$Quantity.in.Millions = as.numeric(gsub("\\$", "", df_china_invest$Quantity.in.Millions))
df_china_invest_grouped = df_china_invest %>%
  filter(!is.na(Quantity.in.Millions)) %>%
  group_by(Country, Sector) %>%
  summarise(Investment_Count=n(),
            amount=sum(Quantity.in.Millions),
            alpha3, numeric, latitude, longitude) %>%
  distinct(Country, Sector, .keep_all = TRUE)

df_china_invest_grouped_all = df_china_invest_grouped %>%
  group_by(Country) %>%
  summarise(amount=sum(amount),
            alpha3, numeric, latitude, longitude) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_agri = df_china_invest_grouped %>%
  filter(Sector=='Agriculture') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_energy = df_china_invest_grouped %>%
  filter(Sector=='Energy') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_trans = df_china_invest_grouped %>%
  filter(Sector=='Transport') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_chem = df_china_invest_grouped %>%
  filter(Sector=='Chemicals') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_metals = df_china_invest_grouped %>%
  filter(Sector=='Metals') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_util = df_china_invest_grouped %>%
  filter(Sector=='Utilities') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_real = df_china_invest_grouped %>%
  filter(Sector=='Real estate') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_fin = df_china_invest_grouped %>%
  filter(Sector=='Finance') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_tech = df_china_invest_grouped %>%
  filter(Sector=='Technology') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_other = df_china_invest_grouped %>%
  filter(Sector=='Other') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_ent = df_china_invest_grouped %>%
  filter(Sector=='Entertainment') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_logs = df_china_invest_grouped %>%
  filter(Sector=='Logistics') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_fin = df_china_invest_grouped %>%
  filter(Sector=='Finance') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_tour = df_china_invest_grouped %>%
  filter(Sector=='Tourism') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)

df_china_invest_grouped_health = df_china_invest_grouped %>%
  filter(Sector=='Health') %>%
  group_by(Country) %>%
  distinct(Country, .keep_all = TRUE) %>%
  arrange(alpha3)
```
```{r Building basemap, include=FALSE}
plot_map <- worldcountry[worldcountry$ADM0_A3 %in% unique(df_china_invest_grouped$alpha3), ]

basemap = leaflet(plot_map, options = leafletOptions(minZoom = 1.25, 
                                                      worldCopyJump=FALSE,
                                                      maxBounds = list(
                                                        list(-90, -180),
                                                        list(90, 180)))) %>% 
  addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addLayersControl(
    position='bottomleft',
    baseGroups=c("All", "Agriculture", "Energy", "Transport", "Chemicals", "Metals", "Utilities", "Real estate", "Finance", "Technology", "Other", "Entertainment", "Logistics", "Tourism", "Health"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  clearBounds()
```
```{r}
# create plotting parameters for map
bins_indiv = c(0, 400, 800, 1600, 3600, 7500, 10000, 15000, 20000, 25000)
rb_indiv <- brewer.pal(9, "Reds")
cv_pal_indiv <- colorBin(rb_indiv, bins = bins_indiv)

bins_all = c(0, 750, 1800, 4200, 9500, 14000, 20000, 27000, 100000)
rb_all <- brewer.pal(9, "Reds")
cv_pal_all <- colorBin(rb_all, bins = bins_all)

# mapping
map = basemap %>% 
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_all$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_all(df_china_invest_grouped_all$amount),
              group='All',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_all$Country, 'All', df_china_invest_grouped_all$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%  
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_agri$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_agri$amount),
              group='Agriculture',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_agri$Country, 'Agriculture', df_china_invest_grouped_agri$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>% 
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_chem$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_chem$amount),
              group='Chemicals',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_chem$Country, 'Chemicals', df_china_invest_grouped_chem$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_energy$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_energy$amount),
              group='Energy',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_energy$Country, 'Energy', df_china_invest_grouped_energy$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_ent$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_ent$amount),
              group='Entertainment',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_ent$Country, 'Entertainment', df_china_invest_grouped_ent$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_fin$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_fin$amount),
              group='Finance',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_fin$Country, 'Finance', df_china_invest_grouped_fin$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_health$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_health$amount),
              group='Health',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_health$Country, 'Health', df_china_invest_grouped_health$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_logs$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_logs$amount),
              group='Logistics',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_logs$Country, 'Logistics', df_china_invest_grouped_logs$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_metals$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_metals$amount),
              group='Metals',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_metals$Country, 'Metals', df_china_invest_grouped_metals$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_other$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_other$amount),
              group='Other',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_other$Country, 'Other', df_china_invest_grouped_other$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_real$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_real$amount),
              group='Real estate',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_real$Country, 'Real estate', df_china_invest_grouped_real$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_tech$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_tech$amount),
              group='Technology',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_tech$Country, 'Technology', df_china_invest_grouped_tech$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_tour$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_tour$amount),
              group='Tourism',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_tour$Country, 'Tourism', df_china_invest_grouped_tour$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_trans$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_trans$amount),
              group='Transport',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_trans$Country, 'Transport', df_china_invest_grouped_trans$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto")) %>%
  addPolygons(data=plot_map[plot_map$ADM0_A3 %in% df_china_invest_grouped_util$alpha3, ],
              stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_util$amount),
              group='Utilities',
              label = sprintf("<strong>%s</strong><br/><strong>Sector</strong>: %s<br/><strong>Investment ($m)</strong>: %1.f",
                              df_china_invest_grouped_util$Country, 'Utilities', df_china_invest_grouped_util$amount) %>% lapply(htmltools::HTML),
              labelOptions = labelOptions(
                                 style = list("font-weight" = "normal", padding = "3px 8px"),
                                 textsize = "12px", direction = "auto"))

map
```

### China's Investment Around the World (Data)

```{r}
df_china_invest_fordt <- rename(df_china_invest_grouped, c('Amount (U. S. Dollars)' = 'amount'))

vars <- c('Country', 'Sector', 'Investment_Count', 'Amount (U. S. Dollars)')

df_china_invest_fordt2 <- df_china_invest_fordt[ ,vars]

pretty_headers <- 
  gsub("[_]", " ", colnames(df_china_invest_fordt2)) %>%
  stringr::str_to_title()

datatable(df_china_invest_fordt2,
          colnames = pretty_headers)
```

Yearly Investments by Categories
=====================================
### Overview

What is China investing in? 

The following page displays the yearly amount of Chinese investments overseas from 2005 to 2020. The amounts are sorted by three categories: 1. the ten largest investment destinations, 2. the five largest Chinese investors and 3. industry sectors. Chinese investments overseas generally reached a peak in the mid-late 2010s, which preceded a slowdown in the following years. The United States is the top investment destination for Chinese investors and the energy sector is consistently the top sector for Chinese investment. There is no one Chinese investor that has dominated Chinese investment overseas, however.


### Yearly Investments in Top 10 Destinations

```{r}
CountryYearly <- chinainv_clean %>% 
  group_by(Year, Country) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm = T),
            .groups = "keep")

byCountry <- CountryYearly %>% 
  group_by(Country) %>% 
  summarise(TotalInvestment = sum(TotalInvestment, na.rm = T)) %>% 
  arrange(desc(TotalInvestment))

top10countries <- byCountry %>% 
  head(10) %>% 
  select(Country) %>% 
  pull()

CountryColor <- data.frame(Country = top10countries,
                           Color = c("#0033cc", "#cc99ff", "#33cc33",
                           "#e600e6", "#ffbf00", "#00e6e6", "#ff6600",
                           "#cc0000", "#003366", "#666633"))

Top10CountryYearly <- CountryYearly %>% 
  filter(Country %in% top10countries) %>% 
  left_join(CountryColor, by = "Country")

countryViz <- Top10CountryYearly %>% 
  ggplot(aes(x = Year, y = TotalInvestment)) +
  geom_line(aes(color = Country)) +
  labs(title = "Chinese Foreign Investments in Top 10 Destinations (2005-2020)",
       y = "Total Investments (in millions USD)") +
  scale_color_manual(breaks = CountryColor$Country,
                     values = CountryColor$Color) +
  ggthemes::theme_tufte() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

ggplotly(countryViz)
```

### Total Foreign Investments in Top 10 Country Destinations

```{r}
top10CountryAmount <- byCountry %>% 
  head(10) 

rankedCountry <- top10CountryAmount %>% 
  ggplot(aes(x = reorder(Country, TotalInvestment),
             y = TotalInvestment)) +
  geom_col(aes(fill = Country)) +
  coord_flip() +
  scale_fill_manual(breaks=CountryColor$Country,
                    values = CountryColor$Color) +
  labs(title = "Total Foreign Investments in Top 10 Country Destinations (2005-2020)",
       x = "",
       y = "Total Investments (in millions USD)") +
  ggthemes::theme_tufte() +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

ggplotly(rankedCountry, tooltip = c("y"))
```

### Yearly Foreign Investments by Top 5 Chinese Investors

```{r}
InvestorYearly <- chinainv_clean %>% 
  group_by(Year, Investor) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm = T),
            .groups = "keep") 

byInvestor <- chinainv_clean %>% 
  group_by(Investor) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm=T)) %>% 
  arrange(desc(TotalInvestment))

top5Investors <- byInvestor %>% 
  head(5) %>% 
  select(Investor) %>% 
  pull()

Top5InvestorYearly <- InvestorYearly %>% 
  filter(Investor %in% top5Investors)

nbColorsInvestor <- 5
InvColors <- colorRampPalette(brewer.pal(5, "Set1"))(nbColorsInvestor)

InvestorColor <- data.frame(Investor = top5Investors, Color = InvColors)

investorViz <- Top5InvestorYearly %>% 
  ggplot(aes(x = Year, y = TotalInvestment)) +
  geom_line(aes(color = Investor)) +
  labs(title = "Chinese Foreign Investments by Five Largest Investors (2005-2020)",
       y = "Total Investments (in millions USD)") +
  ylim(0,20000)+
  scale_color_manual(breaks = InvestorColor$Investor, values=InvestorColor$Color) +
  ggthemes::theme_tufte() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

ggplotly(investorViz)
```

### Total Foreign Investments by Top 5 Chinese Investors

```{r}
top5InvestorAmount <- byInvestor %>% 
  head(5) 

top5InvestorAmount[[5,1]] <- "China Reform\nHoldings,\nChemChina"

InvestorColor1 <- InvestorColor

InvestorColor1[[5,1]] <- "China Reform\nHoldings,\nChemChina"

rankedInvestor <- top5InvestorAmount %>% 
  ggplot(aes(x = reorder(Investor, TotalInvestment),
             y = TotalInvestment)) +
  geom_col(aes(fill = Investor)) +
  scale_fill_manual(breaks = InvestorColor1$Investor, values=InvestorColor1$Color)+
  coord_flip() +
  labs(title = "Total Foreign Investments by Top 5 Chinese Investors (2005-2020)",
       x = "",
       y = "Total Investments (in millions USD)") +
  ggthemes::theme_tufte() +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

ggplotly(rankedInvestor, tooltip = c("y"))
```

### Yearly Foreign Investments by Sector

```{r}
SectorYearly <- chinainv_clean %>% 
  group_by(Year, Sector) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm = T),
            .groups = "keep") 

bySector <- SectorYearly %>% 
  group_by(Sector) %>% 
  summarise(TotalInvestment = sum(TotalInvestment, na.rm = T)) %>% 
  arrange(desc(TotalInvestment))

Sectors <- unique(SectorYearly$Sector)

nb.cols <- 14
mycolors <- colorRampPalette(brewer.pal(9, "Set1"))(nb.cols)

SectorColor <- data.frame(Sector = Sectors, Color = mycolors)

sectorViz <- SectorYearly %>% 
  ggplot(aes(x = Year, y = TotalInvestment)) +
  labs(title = "Chinese Foreign Investments by Sector (2005-2020)",
       y = "Total Investments (in millions USD)") +
  geom_line(aes(color = Sector)) +
  scale_color_manual(breaks = SectorColor$Sector, values = SectorColor$Color) +
  ggthemes::theme_tufte() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
  
ggplotly(sectorViz)
```

### Total Foreign Investments by Sector

```{r}
SectorGrouped <- chinainv_clean %>% 
  group_by(Sector) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm = T)) %>% 
  arrange(desc(TotalInvestment))

rankedSector <- SectorGrouped %>% 
  ggplot(aes(x = reorder(Sector, TotalInvestment),
             y = TotalInvestment)) +
  geom_col(aes(fill = Sector)) +
  coord_flip() +
  scale_fill_manual(breaks=SectorColor$Sector,
                    values = SectorColor$Color) +
  labs(title = "Total Foreign Investments by Sector (2005-2020)",
       x = "",
       y = "Total Investments (in millions USD)") +
  ggthemes::theme_tufte() +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

ggplotly(rankedSector, tooltip = c("y"))
```

Rising Outflows
===================================== 
### FDI Outflows as a percentage of GDP 

What do we know about how China and the US are investing in Africa?

This segment displays line graphs of US and China both seen FDI outflows over the years. Notably, however, one can note how China's rise in FDI outflows have mostly been linear, while the US' seem to fluctuate over time.

Additionally, we can clearly see that China's volume foreign direct investments, as a percentage of their GDP, which seems to be overtaking the United States' in recent years. 

### China's Rising FDI Outflows

```{r}
transposed <- as.data.frame(t(as.matrix(df))) #Transpose
 
#get the variables we want#
colnames(transposed) <- transposed[1,]
transposed$year <- rownames(transposed)

transposed <- transposed %>% #moving year to the first
  select(year, everything())

tranposed_new <- transposed[!(rownames(transposed) %in% c('Country Name', 'Country Code')), ]

tranposed_new$`China` <- as.numeric(tranposed_new$`China`)

tranposed_new$`United States` <- as.numeric(tranposed_new$`United States`)

tranposed_new$`year` <- as.numeric(tranposed_new$`year`)

#write.csv(tranposed_new, 'countriesfdi_new.csv')

colors <- c("China" = "red", "United States" = "blue")

china_us_fdi <- ggplot(tranposed_new) + 
  geom_point(aes(x = `year`, y = `China`, color = "China")) +
  geom_smooth(aes(x = `year`, y = `China`, color = "China"), method='loess', se = F) +
  geom_point(aes(x = `year`, y = `United States`, color = "United States")) + 
  stat_smooth(aes(x = `year`, y = `United States`, color = "United States"), method='loess', se = F) + 
  ggthemes::theme_tufte() + 
  labs(
    x = 'Year',
    y = 'FDI Net Outflows (%GDP)',
    title = 'US vs China FDI Outflows (as %GDP)', 
    color = "Legend"
  ) + 
  scale_color_manual(values = colors)

ggplotly(china_us_fdi, tooltip =c("x", "y"))
```


Next Frontier: Africa
===================================== 
### Commentary

What do we know about how China is investing in Africa?

We can see from the bar charts that the Chinese stake in Africa is getting larger over time, vis a vis the amount that the US is investing. 

Please refer to the map below for the geographic distribution of investments across Africa. 

```{r}
# libraries
library(plotly)
library(tidyr)
library(dplyr)
library(ggmap)
library(scales)
library(countrycode)
library(tmap)
library(geojsonio)

# data manipulation
china_africa_stock = readxl::read_xlsx("./data/FDIData_08Jan2021.xlsx", skip=1, n_max=30)
china_africa_stock = china_africa_stock %>% select(where(function(x) !all(is.na(x)))) %>% rename("year"="US$ mn, unadjusted")
china_africa_flow = readxl::read_xlsx("./data/FDIData_08Jan2021.xlsx", skip=1, n_max=30, sheet=2)
china_africa_flow = china_africa_flow %>% select(where(function(x) !all(is.na(x)))) %>% rename("year"="US$ mn, unadjusted")

china_africa = cbind(china_africa_stock["year"], china_africa_stock["Total, US$ bn"], china_africa_flow["Total, US$ bn"])
names(china_africa) = c("year", "stock", "flow")

us_africa = readxl::read_xlsx("./data/FDIData_08Jan2021.xlsx", skip=1, n_max=30, sheet=6)
us_africa = us_africa %>% rename("year"="US$ bn, unadjusted", "flow"="Flows*", "stock"="Stock")


china_africa_long = pivot_longer(china_africa, 2:3, names_to="fdi_type", values_to="net_investment_value")
china_africa_long$country="China"

us_africa_long = pivot_longer(us_africa, 2:3, names_to="fdi_type", values_to="net_investment_value")
us_africa_long$country="US"

totals = rbind(china_africa_long, us_africa_long)


china_flow_long = china_africa_flow %>% pivot_longer(2:54, names_to="country", values_to="flow_investment") %>%
  filter(!is.na(flow_investment), country!="Regional", country !="Total, US$ mn") %>% select(year, country, flow_investment)

china_stock_long = china_africa_stock %>% pivot_longer(2:54, names_to="country", values_to="stock_investment") %>%
  filter(!is.na(stock_investment), country!="Regional") %>% select(year, country, stock_investment)
china_stock_long$iso = countrycode(china_stock_long$country, origin="country.name", destination="iso3c")

```

### Global pattern holds in Africa as well

We a see a steady year-over-year increase in China stock investment activity to Africa, with plateauing in recent years.

```{r}
stock_plot = ggplot(filter(totals, fdi_type=="stock", year >=2003), aes(x=year, y=net_investment_value, fill=country)) +
  geom_bar(aes(fill=country), stat="identity") +
  ggthemes::theme_tufte() +
  labs(x= "Year", y="Investment amount in billions of USD, unadjusted",
       title="FDI in Africa by Year: Stock") + 
  scale_x_continuous(breaks=2003:2019) + 
  scale_y_continuous(labels=scales::unit_format(unit="b"))

g = ggplotly(stock_plot)
g

```


### Same when looking at flow instead of stock (i.e., from US/China to Africa)

Here, flows are net (inflow and outflow) direct transactions recorded during the reference year. China started to overtake the U.S. in activity in 2014.

```{r}
flow_plot = ggplot(filter(totals, fdi_type=="flow", year >= 2003), aes(x=year, y=net_investment_value, fill=country)) +
  geom_bar(aes(fill=country), stat="identity") +
  ggthemes::theme_tufte() +
  labs(x= "Year", y="Investment amount in billions of USD, unadjusted",
       title="Net FDI to Africa by Year: Flow") + 
  scale_x_continuous(breaks=2003:2019) +
  scale_y_continuous(labels=scales::unit_format(unit="b"), breaks=seq(-3, 12, 2))

ggplotly(flow_plot)
```

### Investment by African country

We can see the time trends for the top 10 most invested in countries in Africa below. Notably, South Africa, a historical outlier within the African continent in terms of economic stability and relationship with Western countries, is an unsurprising outlier in dataset as well.

```{r}
top_10_stock = china_stock_long %>% group_by(country) %>% summarize(max=max(stock_investment)) %>% arrange(desc(max)) %>% head(10) %>% select(country) %>% unlist()
by_country_stock = china_stock_long %>% filter(country %in% top_10_stock) %>%
  plot_ly(x=~year, y=~stock_investment, split=~country, type = "scatter", mode='lines') %>%
  # add_annotations(x=0, y=-.1, xref="paper", yref="paper", text=caption, showarrow=FALSE) %>%
  layout(
    title="Top 10 most invested African countries by year: Stock",
    yaxis=list(title="Investment Amount (US$ million, unadjusted)")
  )
by_country_stock
```

### Zooming in on most recent years in data: 2014-2019 Heatmap

When viewing the information as a heatmap, it's apparent that Congo, Ethiopia, and Nigeria stand out as countries that China is interested in as well. All these countries are particularly rich in raw materials (minerals, oil, etc.).

```{r}
library(leaflet.extras)

china_stock_wide = china_stock_long %>% pivot_wider(id_cols=c(country, iso), names_from=year, values_from="stock_investment")

africa_geo = geojson_read("./data/africa.geo.json", what="sp")
africa_geo@data = africa_geo@data %>% left_join(china_stock_wide, by=c("gu_a3"="iso"))


africa_geo = geojson_read("./data/africa.geo.json", what="sp")
africa_geo@data = africa_geo@data %>% left_join(china_stock_wide, by=c("gu_a3"="iso"))

pal=colorNumeric("Reds", domain=china_stock_long$stock_investment)
leaflet(africa_geo) %>% addTiles() %>% 
  addPolygons(data=africa_geo,
              fillColor=pal(africa_geo$`2019`),
              stroke=FALSE,
              group="2019",
              label=sprintf("Country: %s<br/>Investment (Millions USD): $%1.fm", africa_geo$country, africa_geo$`2019`) %>% lapply(htmltools::HTML)) %>%
  addPolygons(data=africa_geo,
              fillColor=colorNumeric("Reds", domain=africa_geo$`2018`)(africa_geo$`2018`),
              stroke=FALSE,
              group="2018",
              label=sprintf("Country: %s<br/>Investment (Millions USD): $%1.fm", africa_geo$country, africa_geo$`2018`) %>% lapply(htmltools::HTML)) %>%
  addPolygons(data=africa_geo,
              fillColor=pal(africa_geo$`2017`),
              stroke=FALSE,
              group="2017",
              label=sprintf("Country: %s<br/>Investment (Millions USD): $%1.fm", africa_geo$country, africa_geo$`2017`) %>% lapply(htmltools::HTML)) %>%
  addPolygons(data=africa_geo,
              fillColor=pal(africa_geo$`2016`),
              stroke=FALSE,
              group="2016",
              label=sprintf("Country: %s<br/>Investment (Millions USD): $%1.fm", africa_geo$country, africa_geo$`2016`) %>% lapply(htmltools::HTML)) %>%
  addPolygons(data=africa_geo,
              fillColor=pal(africa_geo$`2015`),
              stroke=FALSE,
              group="2015",
              label=sprintf("Country: %s<br/>Investment (Millions USD): $%1.fm", africa_geo$country, africa_geo$`2015`) %>% lapply(htmltools::HTML)) %>%
  addPolygons(data=africa_geo,
              fillColor=pal(africa_geo$`2014`),
              stroke=FALSE,
              group="2014",
              label=sprintf("Country: %s<br/>Investment (Millions USD): $%1.fm", africa_geo$country, africa_geo$`2014`) %>% lapply(htmltools::HTML)) %>%
  addLegend(pal=pal, values=china_stock_long$stock_investment, title="Millions USD",
            position="bottomright") %>%
  addLayersControl(position='bottomleft',
                   baseGroups = c("2019", "2018", "2017", "2016", "2015", "2014"),
                   options = layersControlOptions(collapsed = FALSE)) 
```


```{r}
# old map

# china_stock_wide = china_stock_long %>% pivot_wider(id_cols=c(country, iso), names_from=year, values_from="stock_investment")
# 
# africa_geo = geojson_read("./data/africa.geo.json", what="sp")
# africa_geo@data = africa_geo@data %>% left_join(china_stock_wide, by=c("gu_a3"="iso"))
# 
# 
# m = tm_shape(africa_geo) +
#   tm_borders() +
#   tm_text("country", size = .5) +
#   tm_fill("2019", title="Millions USD", convert2density = FALSE) +
#   tm_layout(
#     main.title="2019 China FDI Heatmap: Stock",
#     frame=FALSE
#   )
# m
```


```{r}
# scratchwork


# library(leaflet.extras)
# leaflet(africa_geo) %>% addTiles() %>% 
#   
#   addPolygons(data=africa_geo,
#               fillColor=colorNumeric("Reds", domain=africa_geo$`2019`)(africa_geo$`2019`),
#               stroke=FALSE,
#               group="2019",
#               label=sprintf("Country: %s<br/>Investment (Millions USD): $%1.fm", africa_geo$country, africa_geo$`2019`) %>% lapply(htmltools::HTML)) %>%
#   addLegend(pal=colorNumeric("Reds", domain=africa_geo$`2019`), values=africa_geo$`2019`, title="Millions USD",
#             group="2019",
#             position="bottomright") %>%
#   addPolygons(data=africa_geo,
#               fillColor=colorNumeric("Reds", domain=africa_geo$`2018`)(africa_geo$`2018`),
#               stroke=FALSE,
#               group="2018",
#               label=sprintf("Country: %s<br/>Investment (Millions USD): $%1.fm", africa_geo$country, africa_geo$`2018`) %>% lapply(htmltools::HTML)) %>%
#   addLegend(pal=colorNumeric("Reds", domain=africa_geo$`2018`), values=africa_geo$`2018`, title="Millions USD",
#             group="2018",
#             position="bottomright") %>%
#   addLayersControl(position='bottomleft',
#                    overlayGroups = c("2019", "2018")) %>%
#                    # options = layersControlOptions(collapsed = FALSE)) %>%
#   leaflet.extras::addResetMapButton()




```


Data Sources and Repo Link
===================================== 

This is the link to the group's repository: https://github.com/QMSS-G5063-2021/Group_B_ChinaWatchers. The data used in this project was taken from the following sources:

### World Map and Yearly Investments by Categories
https://www.aei.org/china-global-investment-tracker/ 

### Rising Tensions
https://data.worldbank.org/indicator/BM.KLT.DINV.CD.WD?end=2019&start=1970&view=chart

### Next Frontier: Africa
http://www.sais-cari.org/chinese-investment-in-africa

